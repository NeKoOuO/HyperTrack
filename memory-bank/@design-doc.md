# Smart Wallet Copy Trading - 設計文檔

## 專案概述

自動追蹤 Hyperliquid 上聰明錢包的交易行為，並在 Lighter 交易所上進行比例跟單。通過 Telegram Bot 進行管理和監控。

## 核心功能

### 1. 錢包追蹤
- 使用 WebSocket 實時監聽指定錢包的持倉變化
- 捕捉開倉、加倉、減倉、平倉、翻轉方向等事件
- 計算倉位比例變化

### 2. 跟單邏輯   
- **比例跟隨**：根據聰明錢包的倉位佔比計算跟單金額
  - 公式：`跟單金額 = 我的總資金 × 聰明錢包倉位佔比`
  - 設定最大單筆金額上限保護
- **同步策略**：
  - 開倉：跟隨開倉
  - 加倉：按比例跟隨加倉
  - 減倉：按比例跟隨減倉
  - 平倉：立即跟隨平倉
  - 翻轉方向：跟隨但需二次確認

### 3. 風險控制
- **止損機制**：當聰明錢包平倉時跟隨止損
- **單筆虧損限制**：倉位虧損達到設定比例（如 -50%）強制平倉
- **價格滑點控制**：市價單，滑點過大時不跟單並通知

### 4. 多錢包管理
- **同交易對鎖定**：同一交易對（如 ETH）只跟第一個觸發的錢包，直到該錢包平倉後其他錢包才能開倉
- **衝突處理**：多空衝突場景暫不處理（預留）

### 5. Telegram 管理界面
- 使用**按鈕式交互**替代命令輸入
- 功能：添加/刪除錢包、查看狀態、修改配置、緊急控制
- 實時通知：新單、平倉、異常、盈虧

## 技術架構

### 系統組件
```
┌─────────────────┐
│  Telegram Bot   │ ◄─── 用戶交互
└────────┬────────┘
         │
    ┌────▼────────────────┐
    │   主控制器 (Main)    │
    └────┬────────────────┘
         │
    ┌────▼─────┐  ┌────────┐  ┌──────────────┐
    │ WebSocket│  │ Lighter │  │  PostgreSQL  │
    │ Tracker  │  │ Trader  │  │  (Railway)   │
    └──────────┘  └────────┘  └──────────────┘
         │             │              │
         ▼             ▼              ▼
    Hyperliquid    Lighter API    雲端數據庫
```

### 數據流
1. WebSocket 監聽聰明錢包 → 觸發事件
2. 策略引擎計算跟單參數
3. 風險檢查通過 → 執行訂單
4. Lighter API 下單 → 記錄結果
5. Telegram 推送通知

## 異常處理

### API 失敗
- 重試 5 次，間隔 3 秒
- 失敗後發送 Telegram 通知

### 下單失敗
- 餘額不足：自動暫停跟單 + 通知
- 市場關閉：通知用戶

### 滑點過大
- 不執行訂單 + 發送通知

### 系統崩潰
- 重啟後掃描漏單並通知用戶

## 部署方案

- **平台**：Railway
- **環境**：Python 3.10+ 容器
- **數據庫**：Railway PostgreSQL 插件
- **日誌**：雲端日誌收集

## 待解決問題

1. 多空衝突場景的處理邏輯（預留）
2. WebSocket 長時間運行的穩定性驗證
3. Hyperliquid API 的頻率限制測試

## 迭代計劃

**V1（MVP）**：
- 單錢包追蹤
- 基礎跟單（開平倉）
- Telegram 基礎管理

**V2**：
- 多錢包支持
- 加減倉同步
- 完整風控

**V3**：
- 進階統計
- 性能優化
- 多用戶支持（可選）

